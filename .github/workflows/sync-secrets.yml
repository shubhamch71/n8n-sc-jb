name: Sync Secrets to Fly.io

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "sync" to confirm secret update'
        required: true
        default: ''

jobs:
  sync-secrets:
    name: Update Fly.io Secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'sync'

    steps:
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Update secrets on Fly.io
        run: |
          flyctl secrets set \
            TELEGRAM_BOT_TOKEN="$TELEGRAM_BOT_TOKEN" \
            TELEGRAM_CHAT_ID="$TELEGRAM_CHAT_ID" \
            N8N_BASIC_AUTH_USER="$N8N_BASIC_AUTH_USER" \
            N8N_BASIC_AUTH_PASSWORD="$N8N_BASIC_AUTH_PASSWORD" \
            TAVILY_API_KEY="$TAVILY_API_KEY" \
            GEMINI_API_KEY="$GEMINI_API_KEY" \
            RAPIDAPI_KEY="$RAPIDAPI_KEY" \
            SERPAPI_KEY="$SERPAPI_KEY" \
            ENABLE_COMPANY_DISCOVERY="$ENABLE_COMPANY_DISCOVERY" \
            ENABLE_AGGREGATOR_APIS="$ENABLE_AGGREGATOR_APIS" \
            ENABLE_NOTIFICATIONS="$ENABLE_NOTIFICATIONS" \
            --app n8n-job-alerts
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          N8N_BASIC_AUTH_USER: ${{ secrets.N8N_BASIC_AUTH_USER }}
          N8N_BASIC_AUTH_PASSWORD: ${{ secrets.N8N_BASIC_AUTH_PASSWORD }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
          ENABLE_COMPANY_DISCOVERY: ${{ vars.ENABLE_COMPANY_DISCOVERY || 'true' }}
          ENABLE_AGGREGATOR_APIS: ${{ vars.ENABLE_AGGREGATOR_APIS || 'true' }}
          ENABLE_NOTIFICATIONS: ${{ vars.ENABLE_NOTIFICATIONS || 'true' }}

      - name: Verify secrets updated
        run: |
          echo "Secrets updated successfully"
          flyctl secrets list --app n8n-job-alerts
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
